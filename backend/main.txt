"""
Config Validator Router
Handles Excel config file validation via subprocess execution.
Validates configs across sheets and produces a Validation sheet with errors.
"""
from fastapi import APIRouter, HTTPException
from pathlib import Path as _Path
import json as _json
from typing import Optional as _Optional
from datetime import datetime
import logging
import sys
import os

sys.path.insert(0, str(_Path(__file__).parent.parent))
from control_execution.control_runner import control_runner
from control_execution.task_persistence import TASK_STORAGE_DIR

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/config-validator", tags=["config-validator"])

# Results storage directory
RESULTS_DIR = TASK_STORAGE_DIR / "config_validator_results"
RESULTS_DIR.mkdir(parents=True, exist_ok=True)


@router.post("/validate")
async def start_validation(request: dict):
    """
    Start config validation by invoking config_validator_script.py as a subprocess.

    Request body:
        - file_path: Path to the Excel config file on the server
    """
    try:
        file_path = request.get("file_path", "").strip()
        if not file_path:
            raise HTTPException(status_code=400, detail="file_path is required")

        # Validate file exists and is an Excel file
        path = _Path(file_path)
        if not path.exists():
            raise HTTPException(status_code=400, detail=f"File not found: {file_path}")
        if path.suffix.lower() not in (".xlsx", ".xls"):
            raise HTTPException(status_code=400, detail="File must be .xlsx or .xls")

        logger.info(f"[ConfigValidator] Starting validation for: {file_path}")

        python_script_path = "api/config_validator_script.py"

        control_params = {
            "control_name": "config_validator",
            "task_name": f"Config Validation - {path.name}",
            "run_env": "DEV",
            "expected_run_date": datetime.now().strftime("%Y-%m-%d"),
            "python_script_path": python_script_path,
            "script_arguments": [file_path],
            "environment_variables": {
                "FILE_PATH": file_path,
                "RESULTS_DIR": str(RESULTS_DIR),
            },
            "control_id": "config_validator",
        }

        result = control_runner.run_control_task(control_params)
        result["file_path"] = file_path

        logger.info(f"[ConfigValidator] Task started: {result.get('task_id')}")
        return result

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"[ConfigValidator] Error starting validation: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/{task_id}/status")
async def get_validation_status(task_id: str):
    """Get status for a specific config validation task."""
    try:
        result = control_runner.get_task_status(task_id)
        return result
    except Exception as e:
        logger.error(f"[ConfigValidator] Error getting status: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/{task_id}/results")
async def get_validation_results(task_id: str):
    """
    Get validation results after completion.
    Reads the results JSON written by the subprocess script.
    """
    try:
        results_file = RESULTS_DIR / f"{task_id}.json"
        if not results_file.exists():
            raise HTTPException(
                status_code=404,
                detail=f"Results not found for task {task_id}. Task may still be running."
            )

        with open(results_file, "r", encoding="utf-8") as f:
            results = _json.load(f)

        results["task_id"] = task_id
        results["retrieved_at"] = datetime.now().isoformat()
        return results

    except HTTPException:
        raise
    except _json.JSONDecodeError as e:
        logger.error(f"[ConfigValidator] Invalid JSON in results file: {e}")
        raise HTTPException(status_code=500, detail="Results file is corrupted")
    except Exception as e:
        logger.error(f"[ConfigValidator] Error getting results: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/{task_id}/logs")
async def get_validation_logs(
    task_id: str,
    log_type: str = "execution",
    lines: int = 200,
    from_line: int = 0
):
    """Get logs for a specific config validation task."""
    try:
        result = control_runner.get_task_logs(task_id, log_type, lines, from_line)
        return result
    except Exception as e:
        logger.error(f"[ConfigValidator] Error getting logs: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/history")
async def get_validation_history(limit: int = 20):
    """Get recent config validation runs."""
    try:
        tasks = control_runner.task_persistence.get_all_tasks(limit=10000) or []
        enriched = []

        for t in tasks:
            state = control_runner.task_persistence.get_task_state(t.get("task_id"))
            if not state:
                continue
            if state.get("control_name") != "config_validator":
                continue
            enriched.append(state)

        # Sort: running first, then by updated_at desc
        def _sort_key(s):
            try:
                status = (s.get("status") or "").lower()
                is_running = status in ["running", "started"]
                updated_at = s.get("updated_at") or s.get("started_at") or ""
                return (1 if is_running else 0, updated_at)
            except Exception:
                return (0, "")

        enriched.sort(key=_sort_key, reverse=True)
        recent = enriched[:limit]

        # Check for results availability
        history = []
        for s in recent:
            task_id = s.get("task_id")
            results_file = RESULTS_DIR / f"{task_id}.json"
            has_results = results_file.exists()

            # Try to read summary from results
            validation_passed = None
            total_errors = None
            if has_results:
                try:
                    with open(results_file, "r", encoding="utf-8") as f:
                        res = _json.load(f)
                    validation_passed = res.get("validation_passed")
                    total_errors = res.get("summary", {}).get("total_errors")
                except Exception:
                    pass

            script_args = s.get("script_arguments", [])
            file_path = script_args[0] if script_args else "unknown"

            history.append({
                "task_id": task_id,
                "file_path": file_path,
                "task_name": s.get("task_name", "Config Validation"),
                "status": s.get("status") or "unknown",
                "validation_passed": validation_passed,
                "total_errors": total_errors,
                "has_results": has_results,
                "created_at": s.get("created_at"),
                "updated_at": s.get("updated_at"),
                "started_at": s.get("started_at"),
                "completed_at": s.get("completed_at") or s.get("ended_at"),
                "return_code": s.get("return_code"),
            })

        return {
            "history": history,
            "limit": limit,
            "retrieved_at": datetime.now().isoformat(),
        }

    except Exception as e:
        logger.error(f"[ConfigValidator] Error getting history: {e}")
        raise HTTPException(status_code=500, detail=str(e))


#Validator


"""
Config Validator Script
Runs as a subprocess to validate Excel config files.
Reads the Excel, validates each sheet, and writes results JSON + validated Excel.

Environment variables:
    TASK_ID: Unique task identifier
    FILE_PATH: Path to the Excel config file
    RESULTS_DIR: Directory to write results JSON
    TASK_FILE_PATH: Path to task state file (set by control_runner)
"""
import os
import sys
import json
import traceback
from pathlib import Path
from datetime import datetime
from copy import copy

try:
    import openpyxl
except ImportError:
    print("ERROR: openpyxl is required. Install with: pip install openpyxl")
    sys.exit(1)


def get_env(name, default=None):
    value = os.environ.get(name, default)
    if value is None:
        print(f"WARNING: Environment variable {name} not set")
    return value


def read_excel_sheets(file_path):
    """Read all sheets from an Excel file using openpyxl. Returns dict of sheet_name -> list of row dicts."""
    print(f"Reading Excel file: {file_path}")
    wb = openpyxl.load_workbook(file_path, read_only=True, data_only=True)
    sheet_names = wb.sheetnames
    print(f"Found {len(sheet_names)} sheets: {sheet_names}")

    sheets_data = {}
    for sheet_name in sheet_names:
        ws = wb[sheet_name]
        rows = list(ws.iter_rows(values_only=True))
        if not rows:
            sheets_data[sheet_name] = {"columns": [], "data": [], "row_count": 0}
            continue

        # First row is header
        headers = [str(h) if h is not None else f"Column_{i}" for i, h in enumerate(rows[0])]
        data = []
        for row in rows[1:]:
            row_dict = {}
            for i, val in enumerate(row):
                col_name = headers[i] if i < len(headers) else f"Column_{i}"
                # Convert to JSON-safe types
                if val is None:
                    row_dict[col_name] = None
                elif isinstance(val, datetime):
                    row_dict[col_name] = val.isoformat()
                elif isinstance(val, (int, float, bool)):
                    row_dict[col_name] = val
                else:
                    row_dict[col_name] = str(val)
            data.append(row_dict)

        sheets_data[sheet_name] = {
            "columns": headers,
            "data": data,
            "row_count": len(data),
        }
        print(f"  Sheet '{sheet_name}': {len(headers)} columns, {len(data)} rows")

    wb.close()
    return sheet_names, sheets_data


def validate_config(sheet_names, sheets_data):
    """
    Validate the config across all sheets.
    Returns a list of validation error dicts.

    ========================================================
    ADD YOUR CUSTOM VALIDATION LOGIC HERE.
    Each error should be a dict with these keys:
        - Sheet: name of the sheet containing the error
        - Row: 1-based row number (relative to data, not header)
        - Column: column name where the error was found
        - Error_Type: category (MISSING_VALUE, INVALID_REFERENCE, DUPLICATE, etc.)
        - Severity: ERROR or WARNING
        - Error_Message: human-readable description
        - Expected_Value: what was expected (optional)
        - Actual_Value: what was found (optional)
    ========================================================
    """
    errors = []
    print("Running validation checks...")

    def add_error(sheet, row, col, error_type, severity, message, expected="", actual=""):
        errors.append({
            "Sheet": sheet,
            "Row": row,
            "Column": col,
            "Error_Type": error_type,
            "Severity": severity,
            "Error_Message": message,
            "Expected_Value": expected,
            "Actual_Value": actual,
        })

    # --- Define required columns per sheet ---
    # Map sheet name -> list of columns that must not be empty
    required_columns = {
        "InputFiles": ["SourceName", "FilePath", "FileType", "Encoding", "Active"],
        "Rules": ["RuleID", "RuleName", "SourceField", "TargetField", "MatchType", "Active"],
        "Enrichment": ["EnrichmentID", "SourceSheet", "LookupField", "LookupSource", "OutputField", "Active"],
        "FieldOperations": ["OperationID", "InputField", "Operation", "OutputField", "Active"],
        "OutputRules": ["OutputID", "OutputName", "OutputPath", "Format", "Active"],
    }

    for sheet_name in sheet_names:
        sheet_info = sheets_data.get(sheet_name, {})
        data = sheet_info.get("data", [])
        columns = sheet_info.get("columns", [])

        if not data:
            continue

        req_cols = required_columns.get(sheet_name, [])

        # Rule 1: Check required columns for empty/null values (ERROR severity)
        for row_idx, row in enumerate(data):
            for col in req_cols:
                if col not in columns:
                    continue
                val = row.get(col)
                if val is None or (isinstance(val, str) and val.strip() == ""):
                    add_error(
                        sheet_name, row_idx + 2, col,
                        "MISSING_VALUE", "ERROR",
                        f"Required field '{col}' is empty",
                        "Non-empty value",
                        "(null)" if val is None else "(empty)",
                    )

        # Rule 2: Check optional columns for empty/null values (WARNING severity)
        for row_idx, row in enumerate(data):
            for col in columns:
                if col in req_cols:
                    continue  # Already checked above
                val = row.get(col)
                if val is None or (isinstance(val, str) and val.strip() == ""):
                    add_error(
                        sheet_name, row_idx + 2, col,
                        "MISSING_VALUE", "WARNING",
                        f"Optional field '{col}' is empty",
                        "Non-empty value",
                        "(null)" if val is None else "(empty)",
                    )

    # Rule 3: Cross-sheet reference validation (Enrichment.SourceSheet must be a valid sheet name)
    enrichment = sheets_data.get("Enrichment", {})
    enr_data = enrichment.get("data", [])
    enr_cols = enrichment.get("columns", [])
    if "SourceSheet" in enr_cols:
        for row_idx, row in enumerate(enr_data):
            ref = row.get("SourceSheet")
            if ref and isinstance(ref, str) and ref.strip() and ref not in sheet_names:
                add_error(
                    "Enrichment", row_idx + 2, "SourceSheet",
                    "INVALID_REFERENCE", "ERROR",
                    f"SourceSheet '{ref}' does not exist in workbook",
                    f"One of: {', '.join(sheet_names)}",
                    ref,
                )

    # Rule 4: Duplicate detection in Rules sheet (same SourceField + TargetField)
    rules = sheets_data.get("Rules", {})
    rules_data = rules.get("data", [])
    rules_cols = rules.get("columns", [])
    if "SourceField" in rules_cols and "TargetField" in rules_cols:
        seen = {}
        for row_idx, row in enumerate(rules_data):
            src = row.get("SourceField", "")
            tgt = row.get("TargetField", "")
            if src and tgt:
                key = f"{src}|{tgt}"
                if key in seen:
                    add_error(
                        "Rules", row_idx + 2, "SourceField",
                        "DUPLICATE", "ERROR",
                        f"Duplicate rule: SourceField='{src}' + TargetField='{tgt}' already defined at row {seen[key]}",
                        "Unique SourceField+TargetField combination",
                        f"Duplicate of row {seen[key]}",
                    )
                else:
                    seen[key] = row_idx + 2

    print(f"Validation complete. Found {len(errors)} issues.")
    return errors


def build_summary(errors, sheet_names):
    """Build validation summary statistics."""
    total_errors = sum(1 for e in errors if e["Severity"] == "ERROR")
    total_warnings = sum(1 for e in errors if e["Severity"] == "WARNING")

    errors_by_sheet = {}
    for e in errors:
        sheet = e["Sheet"]
        errors_by_sheet[sheet] = errors_by_sheet.get(sheet, 0) + 1

    errors_by_type = {}
    for e in errors:
        etype = e["Error_Type"]
        errors_by_type[etype] = errors_by_type.get(etype, 0) + 1

    errors_by_severity = {}
    for e in errors:
        sev = e["Severity"]
        errors_by_severity[sev] = errors_by_severity.get(sev, 0) + 1

    return {
        "total_errors": total_errors,
        "total_warnings": total_warnings,
        "total_issues": len(errors),
        "errors_by_sheet": errors_by_sheet,
        "errors_by_type": errors_by_type,
        "errors_by_severity": errors_by_severity,
        "sheets_validated": sheet_names,
        "validation_duration_seconds": 0,  # Updated below
    }


def write_validated_excel(original_path, errors):
    """
    Create a copy of the Excel file with an added 'Validation' sheet containing errors.
    Returns the path to the validated file.
    """
    if not errors:
        return None

    original = Path(original_path)
    validated_path = original.parent / f"{original.stem}_validated{original.suffix}"
    print(f"Writing validated Excel to: {validated_path}")

    wb = openpyxl.load_workbook(original_path)

    # Remove existing Validation sheet if present
    if "Validation" in wb.sheetnames:
        del wb["Validation"]

    ws = wb.create_sheet("Validation")

    # Write header
    validation_columns = [
        "Sheet", "Row", "Column", "Error_Type", "Severity",
        "Error_Message", "Expected_Value", "Actual_Value"
    ]
    for col_idx, col_name in enumerate(validation_columns, 1):
        cell = ws.cell(row=1, column=col_idx, value=col_name)
        cell.font = openpyxl.styles.Font(bold=True)

    # Write error rows
    for row_idx, error in enumerate(errors, 2):
        for col_idx, col_name in enumerate(validation_columns, 1):
            val = error.get(col_name, "")
            ws.cell(row=row_idx, column=col_idx, value=val)

    # Auto-fit column widths (approximate)
    for col_idx, col_name in enumerate(validation_columns, 1):
        max_len = len(col_name)
        for row_idx in range(2, min(len(errors) + 2, 102)):  # Check first 100 rows
            cell_val = str(ws.cell(row=row_idx, column=col_idx).value or "")
            max_len = max(max_len, len(cell_val))
        ws.column_dimensions[openpyxl.utils.get_column_letter(col_idx)].width = min(max_len + 2, 50)

    wb.save(validated_path)
    wb.close()
    print(f"Validated Excel written with {len(errors)} error rows")
    return str(validated_path)


def main():
    start_time = datetime.now()
    task_id = get_env("TASK_ID", "unknown")
    file_path = get_env("FILE_PATH")
    results_dir = get_env("RESULTS_DIR")

    print("=" * 70)
    print(f"Config Validator Script")
    print(f"Task ID: {task_id}")
    print(f"File: {file_path}")
    print(f"Results Dir: {results_dir}")
    print(f"Started: {start_time.isoformat()}")
    print("=" * 70)

    if not file_path:
        print("ERROR: FILE_PATH environment variable is required")
        sys.exit(1)

    if not Path(file_path).exists():
        print(f"ERROR: File not found: {file_path}")
        sys.exit(1)

    try:
        # Step 1: Read Excel
        print("\n[Step 1/4] Reading Excel file...")
        sheet_names, sheets_data = read_excel_sheets(file_path)

        # Step 2: Validate
        print("\n[Step 2/4] Running validation...")
        errors = validate_config(sheet_names, sheets_data)

        # Step 3: Build summary
        print("\n[Step 3/4] Building summary...")
        validation_passed = len([e for e in errors if e["Severity"] == "ERROR"]) == 0
        summary = build_summary(errors, sheet_names)

        end_time = datetime.now()
        duration = (end_time - start_time).total_seconds()
        summary["validation_duration_seconds"] = round(duration, 2)

        # Step 4: Write outputs
        print("\n[Step 4/4] Writing outputs...")

        # Write validated Excel (only if errors exist)
        validated_file_path = None
        if errors:
            validated_file_path = write_validated_excel(file_path, errors)

        # Build validation sheet data for results JSON
        validation_sheet = None
        if errors:
            validation_columns = [
                "Sheet", "Row", "Column", "Error_Type", "Severity",
                "Error_Message", "Expected_Value", "Actual_Value"
            ]
            validation_sheet = {
                "columns": validation_columns,
                "data": errors,
                "row_count": len(errors),
                "error_count": len(errors),
            }

        # Add error_count per sheet
        for sheet_name in sheet_names:
            sheet_errors = sum(1 for e in errors if e["Sheet"] == sheet_name)
            sheets_data[sheet_name]["error_count"] = sheet_errors

        # Build results JSON
        results = {
            "status": "completed",
            "file_path": file_path,
            "validation_passed": validation_passed,
            "summary": summary,
            "sheet_names": sheet_names,
            "sheets": sheets_data,
            "completed_at": end_time.isoformat(),
        }

        # Add validation sheet to results if errors exist
        if validation_sheet:
            results["sheets"]["Validation"] = validation_sheet
            results["validated_file_path"] = validated_file_path

        # Write results JSON
        if results_dir:
            results_path = Path(results_dir) / f"{task_id}.json"
            results_path.parent.mkdir(parents=True, exist_ok=True)
            with open(results_path, "w", encoding="utf-8") as f:
                json.dump(results, f, indent=2, default=str)
            print(f"Results written to: {results_path}")

        # Print summary
        print("\n" + "=" * 70)
        print(f"VALIDATION {'PASSED' if validation_passed else 'FAILED'}")
        print(f"Total Issues: {len(errors)}")
        print(f"  Errors: {summary['total_errors']}")
        print(f"  Warnings: {summary['total_warnings']}")
        if summary["errors_by_sheet"]:
            print(f"  By Sheet: {summary['errors_by_sheet']}")
        if summary["errors_by_type"]:
            print(f"  By Type: {summary['errors_by_type']}")
        print(f"Duration: {duration:.2f}s")
        if validated_file_path:
            print(f"Validated Excel: {validated_file_path}")
        print("=" * 70)

    except Exception as e:
        print(f"\nFATAL ERROR: {e}")
        traceback.print_exc()

        # Write error results
        if results_dir:
            error_results = {
                "status": "failed",
                "file_path": file_path,
                "validation_passed": None,
                "error": str(e),
                "traceback": traceback.format_exc(),
                "completed_at": datetime.now().isoformat(),
            }
            results_path = Path(results_dir) / f"{task_id}.json"
            results_path.parent.mkdir(parents=True, exist_ok=True)
            with open(results_path, "w", encoding="utf-8") as f:
                json.dump(error_results, f, indent=2)

        sys.exit(1)


if __name__ == "__main__":
    main()
  ### PAGE JS

import { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { AgGridReact } from 'ag-grid-react';
import 'ag-grid-community/styles/ag-grid.css';
import 'ag-grid-community/styles/ag-theme-alpine.css';
import ApiService from '../../services/api';
import HSBCLogo from '../../components/HSBCLogo';
import ValidationSummary from './ValidationSummary';
import { FaCheckCircle, FaPlay, FaTimes, FaTimesCircle, FaSpinner, FaHistory, FaExclamationTriangle } from 'react-icons/fa';

const ConfigValidatorPage = () => {
    // Input state
    const [filePath, setFilePath] = useState('');

    // Validation state
    const [validationState, setValidationState] = useState('idle'); // idle | validating | completed | failed | error
    const [taskId, setTaskId] = useState(null);
    const [results, setResults] = useState(null);
    const [error, setError] = useState(null);

    // Sheet display state
    const [activeSheet, setActiveSheet] = useState('');
    const [sheetNames, setSheetNames] = useState([]);

    // History state
    const [history, setHistory] = useState([]);
    const [showHistory, setShowHistory] = useState(false);

    // Polling ref
    const pollingRef = useRef(null);

    // Load history on mount
    useEffect(() => {
        loadHistory();
    }, []);

    // Cleanup polling on unmount
    useEffect(() => {
        return () => {
            if (pollingRef.current) {
                clearInterval(pollingRef.current);
            }
        };
    }, []);

    const loadHistory = async () => {
        try {
            const response = await ApiService.getConfigValidationHistory(20);
            setHistory(response.history || []);
        } catch (err) {
            // History loading is non-critical
        }
    };

    const handleValidate = async () => {
        if (!filePath.trim()) {
            setError('Please enter a file path');
            return;
        }

        setError(null);
        setResults(null);
        setValidationState('validating');
        setSheetNames([]);
        setActiveSheet('');

        try {
            const response = await ApiService.startConfigValidation(filePath.trim());
            const newTaskId = response.task_id;
            setTaskId(newTaskId);

            // Start polling for status
            pollingRef.current = setInterval(async () => {
                try {
                    const status = await ApiService.getConfigValidationStatus(newTaskId);
                    const taskStatus = (status.status || '').toLowerCase();

                    if (taskStatus === 'completed' || taskStatus === 'success') {
                        clearInterval(pollingRef.current);
                        pollingRef.current = null;
                        await fetchResults(newTaskId);
                    } else if (taskStatus === 'failed' || taskStatus === 'error') {
                        clearInterval(pollingRef.current);
                        pollingRef.current = null;
                        setValidationState('error');
                        setError(`Validation process failed. Check logs for task ${newTaskId}`);
                        // Still try to fetch results (might have partial data)
                        try {
                            await fetchResults(newTaskId);
                        } catch {
                            // No results available
                        }
                    }
                } catch (err) {
                    // Polling error - keep trying
                }
            }, 2000);

        } catch (err) {
            setValidationState('error');
            setError(err.message);
        }
    };

    const fetchResults = async (tid) => {
        try {
            const data = await ApiService.getConfigValidationResults(tid);

            if (data.status === 'failed' && data.error) {
                setValidationState('error');
                setError(data.error);
                return;
            }

            setResults(data);

            // Build sheet names list
            const names = data.sheet_names || [];
            const allNames = [...names];
            // Show Validation tab whenever it exists with data (errors OR warnings)
            if (data.sheets && data.sheets['Validation'] && data.sheets['Validation'].row_count > 0) {
                allNames.push('Validation');
            }
            setSheetNames(allNames);

            // Set first sheet as active
            if (allNames.length > 0) {
                setActiveSheet(allNames[0]);
            }

            // Determine state: failed if any issues exist, completed if clean
            const hasIssues = data.summary && (data.summary.total_issues > 0 || data.summary.total_errors > 0 || data.summary.total_warnings > 0);
            setValidationState(hasIssues ? 'failed' : 'completed');
            loadHistory(); // Refresh history
        } catch (err) {
            setValidationState('error');
            setError(`Failed to fetch results: ${err.message}`);
        }
    };

    const handleClear = () => {
        if (pollingRef.current) {
            clearInterval(pollingRef.current);
            pollingRef.current = null;
        }
        setFilePath('');
        setValidationState('idle');
        setTaskId(null);
        setResults(null);
        setError(null);
        setSheetNames([]);
        setActiveSheet('');
    };

    const handleHistoryClick = async (item) => {
        setFilePath(item.file_path || '');
        setShowHistory(false);

        if (item.has_results && item.task_id) {
            setTaskId(item.task_id);
            setValidationState('validating');
            await fetchResults(item.task_id);
        }
    };

    const handleKeyPress = (e) => {
        if (e.key === 'Enter' && validationState !== 'validating') {
            handleValidate();
        }
    };

    // AG Grid data for active sheet
    const activeSheetData = useMemo(() => {
        if (!results || !results.sheets || !activeSheet) return [];
        const sheet = results.sheets[activeSheet];
        return sheet ? (sheet.data || []) : [];
    }, [results, activeSheet]);

    // AG Grid column definitions for active sheet
    const columnDefs = useMemo(() => {
        if (!results || !results.sheets || !activeSheet) return [];
        const sheet = results.sheets[activeSheet];
        if (!sheet || !sheet.columns) return [];

        return sheet.columns.map(col => ({
            headerName: col,
            field: col,
            minWidth: 120,
            flex: 1,
            resizable: true,
            sortable: true,
            filter: true,
        }));
    }, [results, activeSheet]);

    const defaultColDef = useMemo(() => ({
        sortable: true,
        filter: true,
        resizable: true,
        minWidth: 100,
    }), []);

    // Row styling for Validation sheet
    const getRowStyle = useCallback((params) => {
        if (activeSheet !== 'Validation') return null;
        const severity = params.data?.Severity;
        if (severity === 'ERROR') {
            return { backgroundColor: '#FEE2E2' };
        }
        if (severity === 'WARNING') {
            return { backgroundColor: '#FEF3C7' };
        }
        if (severity === 'INFO') {
            return { backgroundColor: '#DBEAFE' };
        }
        return null;
    }, [activeSheet]);

    // Get error count badge for a sheet tab
    const getSheetErrorCount = (sheetName) => {
        if (!results || !results.sheets) return 0;
        const sheet = results.sheets[sheetName];
        return sheet?.error_count || 0;
    };

    return (
        <div className="min-h-screen bg-gray-100">
            {/* Loading Overlay */}
            {validationState === 'validating' && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-8 flex flex-col items-center shadow-xl">
                        <div className="animate-spin rounded-full h-16 w-16 border-4 border-red-500 border-t-transparent mb-4"></div>
                        <p className="text-gray-700 text-lg font-medium">Validating config...</p>
                        <p className="text-gray-500 text-sm mt-1">{filePath.split(/[/\\]/).pop()}</p>
                    </div>
                </div>
            )}

            {/* Header */}
            <div className="border-b border-slate-200 px-8 py-4"
                style={{
                    backgroundColor: 'white',
                    height: '80px',
                    boxShadow: '0 4px 8px rgba(0,0,0,0.15), 0 8px 16px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.1), inset 0 2px 0 rgba(255,255,255,0.8), inset 0 -2px 0 rgba(0,0,0,0.1)'
                }}>
                <div className="flex items-center justify-between h-full">
                    <div className="flex items-center flex-shrink-0">
                        <HSBCLogo height={64} className="mr-4" />
                    </div>
                    <div className="flex-1 flex justify-center">
                        <h1 className="text-2xl font-bold text-black text-center">
                            CONFIG VALIDATOR
                        </h1>
                    </div>
                    <div className="flex-shrink-0 flex items-center gap-2">
                        <button
                            onClick={() => setShowHistory(!showHistory)}
                            className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
                        >
                            <FaHistory />
                            History
                        </button>
                        <div className="px-3 py-1 rounded-lg text-sm font-medium bg-gray-100 text-gray-700">
                            {new Date().toLocaleDateString()}
                        </div>
                    </div>
                </div>
            </div>

            {/* Main Content */}
            <div className="px-6 py-4">
                {/* File Path Input */}
                <div className="bg-white rounded-lg shadow-sm p-4 mb-4">
                    <div className="flex items-center gap-3">
                        <label className="text-sm font-medium text-gray-700 whitespace-nowrap">
                            File Path:
                        </label>
                        <input
                            type="text"
                            value={filePath}
                            onChange={(e) => setFilePath(e.target.value)}
                            onKeyDown={handleKeyPress}
                            placeholder="Enter path to Excel config file (e.g., /path/to/config.xlsx)"
                            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm"
                            disabled={validationState === 'validating'}
                        />
                        <button
                            onClick={handleValidate}
                            disabled={validationState === 'validating' || !filePath.trim()}
                            className="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed text-sm font-medium"
                        >
                            {validationState === 'validating' ? (
                                <FaSpinner className="animate-spin" />
                            ) : (
                                <FaPlay />
                            )}
                            Validate
                        </button>
                        <button
                            onClick={handleClear}
                            className="flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium"
                        >
                            <FaTimes />
                            Clear
                        </button>
                    </div>
                </div>

                {/* Error Display */}
                {error && (
                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                        {error}
                    </div>
                )}

                {/* Validation Summary */}
                {results && results.summary && (
                    <ValidationSummary
                        summary={results.summary}
                        validationPassed={results.validation_passed}
                        onSheetClick={(sheet) => setActiveSheet(sheet)}
                    />
                )}

                {/* Sheet Tabs + Grid */}
                {sheetNames.length > 0 && (
                    <div className="bg-white rounded-lg shadow-sm">
                        {/* Sheet Tabs */}
                        <div className="flex items-center border-b border-gray-200 px-2 pt-2 overflow-x-auto">
                            {sheetNames.map((name) => {
                                const isValidation = name === 'Validation';
                                const errorCount = getSheetErrorCount(name);
                                const isActive = activeSheet === name;

                                return (
                                    <button
                                        key={name}
                                        onClick={() => setActiveSheet(name)}
                                        className={`flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap ${
                                            isActive
                                                ? isValidation
                                                    ? 'bg-red-50 text-red-700 border border-b-0 border-red-200'
                                                    : 'bg-white text-gray-900 border border-b-0 border-gray-200'
                                                : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        {isValidation && (
                                            <FaExclamationTriangle className="text-red-500" />
                                        )}
                                        {name}
                                        {errorCount > 0 && !isValidation && (
                                            <span className="px-1.5 py-0.5 text-xs rounded-full bg-red-100 text-red-600 font-bold">
                                                {errorCount}
                                            </span>
                                        )}
                                        {isValidation && results?.sheets?.Validation && (
                                            <span className="px-1.5 py-0.5 text-xs rounded-full bg-red-500 text-white font-bold">
                                                {results.sheets.Validation.row_count}
                                            </span>
                                        )}
                                    </button>
                                );
                            })}
                        </div>

                        {/* Sheet Info Bar */}
                        <div className="px-4 py-2 border-b border-gray-100 flex items-center justify-between text-sm text-gray-500">
                            <span>
                                {activeSheet}
                                {results?.sheets?.[activeSheet] && (
                                    <> - {results.sheets[activeSheet].row_count} rows, {results.sheets[activeSheet].columns?.length || 0} columns</>
                                )}
                            </span>
                            {results?.validated_file_path && (
                                <span className="text-gray-400">
                                    Validated file: {results.validated_file_path}
                                </span>
                            )}
                        </div>

                        {/* AG Grid */}
                        <div className="ag-theme-alpine" style={{ height: 'calc(100vh - 400px)', minHeight: '400px', width: '100%' }}>
                            <AgGridReact
                                rowData={activeSheetData}
                                columnDefs={columnDefs}
                                defaultColDef={defaultColDef}
                                animateRows={true}
                                pagination={false}
                                enableCellTextSelection={true}
                                ensureDomOrder={true}
                                getRowStyle={getRowStyle}
                            />
                        </div>
                    </div>
                )}

                {/* Initial State */}
                {validationState === 'idle' && !results && !error && (
                    <div className="bg-white rounded-lg shadow-sm p-12 text-center">
                        <FaCheckCircle className="text-6xl text-gray-300 mx-auto mb-4" />
                        <h3 className="text-lg font-medium text-gray-700 mb-2">Ready to Validate</h3>
                        <p className="text-gray-500 max-w-md mx-auto">
                            Enter the path to an Excel configuration file above and click Validate to check for errors across all sheets.
                        </p>
                    </div>
                )}

                {/* History Panel */}
                {showHistory && history.length > 0 && (
                    <div className="mt-4 bg-white rounded-lg shadow-sm">
                        <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                            <span className="font-medium text-gray-700 flex items-center gap-2">
                                <FaHistory className="text-gray-400" />
                                Recent Validations
                            </span>
                            <button
                                onClick={() => setShowHistory(false)}
                                className="text-gray-400 hover:text-gray-600"
                            >
                                <FaTimes />
                            </button>
                        </div>
                        <div className="divide-y divide-gray-100 max-h-64 overflow-y-auto">
                            {history.map((item) => {
                                const fileName = item.file_path?.split(/[/\\]/).pop() || 'unknown';
                                const status = (item.status || '').toLowerCase();
                                const passed = item.validation_passed;
                                const timeAgo = getTimeAgo(item.completed_at || item.created_at);

                                return (
                                    <button
                                        key={item.task_id}
                                        onClick={() => handleHistoryClick(item)}
                                        className="w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center justify-between"
                                    >
                                        <div className="flex items-center gap-3">
                                            {passed === true && (
                                                <FaCheckCircle className="text-green-500 flex-shrink-0" />
                                            )}
                                            {passed === false && (
                                                <FaTimesCircle className="text-red-500 flex-shrink-0" />
                                            )}
                                            {passed === null && (
                                                <FaSpinner className={`text-gray-400 flex-shrink-0 ${status === 'running' ? 'animate-spin' : ''}`} />
                                            )}
                                            <div>
                                                <div className="text-sm font-medium text-gray-800">{fileName}</div>
                                                <div className="text-xs text-gray-500">{item.file_path}</div>
                                            </div>
                                        </div>
                                        <div className="text-right flex-shrink-0">
                                            {item.total_errors !== null && item.total_errors !== undefined && (
                                                <div className="text-xs text-red-500 font-medium">{item.total_errors} errors</div>
                                            )}
                                            <div className="text-xs text-gray-400">{timeAgo}</div>
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

function getTimeAgo(isoString) {
    if (!isoString) return '';
    try {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
    } catch {
        return '';
    }
}

export default ConfigValidatorPage;
  ### Val Summ

import { FaCheckCircle, FaTimesCircle, FaExclamationTriangle } from 'react-icons/fa';

const ValidationSummary = ({ summary, validationPassed, onSheetClick }) => {
    if (!summary) return null;

    const {
        total_errors = 0,
        total_warnings = 0,
        total_issues = 0,
        errors_by_sheet = {},
        errors_by_type = {},
        validation_duration_seconds = 0,
    } = summary;

    const hasIssues = total_issues > 0 || total_errors > 0 || total_warnings > 0;
    const hasErrors = total_errors > 0;

    // Three states: clean (green), warnings only (yellow), errors (red)
    const bgClass = !hasIssues
        ? 'bg-green-50 border-green-200'
        : hasErrors
            ? 'bg-red-50 border-red-200'
            : 'bg-yellow-50 border-yellow-200';

    const statusIcon = !hasIssues
        ? <FaCheckCircle className="text-green-500 text-2xl" />
        : hasErrors
            ? <FaTimesCircle className="text-red-500 text-2xl" />
            : <FaExclamationTriangle className="text-yellow-500 text-2xl" />;

    const statusText = !hasIssues
        ? 'VALIDATION PASSED'
        : hasErrors
            ? 'VALIDATION FAILED'
            : 'VALIDATION PASSED WITH WARNINGS';

    const statusColor = !hasIssues
        ? 'text-green-700'
        : hasErrors
            ? 'text-red-700'
            : 'text-yellow-700';

    return (
        <div className={`rounded-lg border p-4 mb-4 ${bgClass}`}>
            <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-3">
                    {statusIcon}
                    <span className={`text-lg font-bold ${statusColor}`}>
                        {statusText}
                    </span>
                </div>
                <div className="flex items-center gap-4 text-sm">
                    {total_errors > 0 && (
                        <span className="flex items-center gap-1 text-red-600 font-medium">
                            <FaTimesCircle />
                            {total_errors} {total_errors === 1 ? 'Error' : 'Errors'}
                        </span>
                    )}
                    {total_warnings > 0 && (
                        <span className="flex items-center gap-1 text-yellow-600 font-medium">
                            <FaExclamationTriangle />
                            {total_warnings} {total_warnings === 1 ? 'Warning' : 'Warnings'}
                        </span>
                    )}
                    {validation_duration_seconds > 0 && (
                        <span className="text-gray-500">
                            {validation_duration_seconds.toFixed(1)}s
                        </span>
                    )}
                </div>
            </div>

            {hasIssues && (
                <div className="flex flex-wrap gap-4 text-sm">
                    {/* Issues by Sheet */}
                    {Object.keys(errors_by_sheet).length > 0 && (
                        <div>
                            <span className="text-gray-600 font-medium mr-2">By Sheet:</span>
                            {Object.entries(errors_by_sheet).map(([sheet, count]) => (
                                <button
                                    key={sheet}
                                    onClick={() => onSheetClick && onSheetClick(sheet)}
                                    className={`inline-flex items-center gap-1 px-2 py-0.5 rounded mr-1 hover:opacity-80 transition-colors cursor-pointer ${
                                        hasErrors ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'
                                    }`}
                                >
                                    {sheet}
                                    <span className="font-bold">({count})</span>
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Issues by Type */}
                    {Object.keys(errors_by_type).length > 0 && (
                        <div>
                            <span className="text-gray-600 font-medium mr-2">By Type:</span>
                            {Object.entries(errors_by_type).map(([type, count]) => (
                                <span
                                    key={type}
                                    className="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-gray-100 text-gray-700 mr-1"
                                >
                                    {type}
                                    <span className="font-bold">({count})</span>
                                </span>
                            ))}
                        </div>
                    )}
                </div>
            )}
        </div>
    );
};

export default ValidationSummary;

    // ==========================================
    // Config Validator Methods
    // ==========================================

    static async startConfigValidation(filePath) {
        return this.retryRequest(async () => {
            const response = await this.fetchWithTimeout(
                `${API_BASE_URL}/api/config-validator/validate`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: filePath }),
                }
            );

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Failed to start validation: ${response.statusText}`);
            }

            return await response.json();
        });
    }

    static async getConfigValidationStatus(taskId) {
        return this.retryRequest(async () => {
            const response = await this.fetchWithTimeout(
                `${API_BASE_URL}/api/config-validator/${taskId}/status`
            );

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Failed to get validation status: ${response.statusText}`);
            }

            return await response.json();
        });
    }

    static async getConfigValidationResults(taskId) {
        return this.retryRequest(async () => {
            const response = await this.fetchWithTimeout(
                `${API_BASE_URL}/api/config-validator/${taskId}/results`
            );

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Failed to get validation results: ${response.statusText}`);
            }

            return await response.json();
        });
    }

    static async getConfigValidationLogs(taskId, logType = 'execution', lines = 200) {
        return this.retryRequest(async () => {
            const params = new URLSearchParams({
                log_type: logType,
                lines: lines.toString(),
            });

            const response = await this.fetchWithTimeout(
                `${API_BASE_URL}/api/config-validator/${taskId}/logs?${params.toString()}`
            );

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Failed to get validation logs: ${response.statusText}`);
            }

            return await response.json();
        });
    }

    static async getConfigValidationHistory(limit = 20) {
        return this.retryRequest(async () => {
            const params = new URLSearchParams({ limit: limit.toString() });

            const response = await this.fetchWithTimeout(
                `${API_BASE_URL}/api/config-validator/history?${params.toString()}`
            );

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Failed to get validation history: ${response.statusText}`);
            }

            return await response.json();
        });
    }

#### PAGEJS
import { FaChartLine, FaCheckCircle, FaCog, FaServer, FaDesktop, FaFlask, FaRobot, FaChartBar, FaSearch, FaFileAlt } from 'react-icons/fa';

  const openConfigValidator = () => {
    window.open('/config-validator', '_blank');
  };

            {/* Feature 12 - Config Validator */}
            <div
              onClick={openConfigValidator}
              className="group rounded-lg border border-slate-200 p-6 transition-all duration-300 ease-in-out bg-white hover:scale-105 hover:shadow-xl hover:shadow-slate-700/10 cursor-pointer transform-gpu"
            >
              <div className="flex items-center gap-4 mb-4">
                <div className="p-3 rounded-lg bg-white text-red-500 transition-colors">
                  <FaFileAlt size={32} />
                </div>
                <h3 className="text-lg font-semibold text-black">CONFIG VALIDATOR</h3>
              </div>
              <p className="mt-2 text-black">
                Validate Excel configuration files across all sheets. Identify missing values, invalid references, and data issues with detailed error reporting.
              </p>
            </div>

# INDEX

import ConfigValidatorPage from './controls/config-validator/page';
<Route path="/config-validator" element={<ConfigValidatorPage />} />
